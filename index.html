<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Oklahoma City Â· KPI Dashboard 2026</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;500;600;700;800&family=Barlow:wght@300;400;500;600&family=JetBrains+Mono:wght@300;400;500&display=swap');

  :root {
    --bg:         #f2f1ef;
    --surface:    #ffffff;
    --card:       #ffffff;
    --sidebar:    #1a1a1a;
    --sidebar-h:  #242424;
    --border:     #e0ddd8;
    --border-dk:  #c8c4bc;
    --red:        #c8102e;
    --red-dk:     #9e0a22;
    --red-lt:     #fce8ec;
    --grey:       #6b6b6b;
    --grey-lt:    #adadad;
    --charcoal:   #1a1a1a;
    --text:       #1a1a1a;
    --muted:      #7a7a7a;
    --green:      #1a7a46;
    --green-bg:   #e8f5ee;
    --amber:      #b45309;
    --shadow-sm:  0 1px 3px rgba(0,0,0,.07);
    --shadow:     0 2px 10px rgba(0,0,0,.09);
    --shadow-lg:  0 6px 24px rgba(0,0,0,.12);
  }
  * { box-sizing:border-box; margin:0; padding:0; }
  body { font-family:'Barlow',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; overflow-x:hidden; }

  /* â”€â”€ HEADER â”€â”€ */
  .header { display:flex; align-items:center; justify-content:space-between; padding:0 26px; height:54px; background:var(--charcoal); border-bottom:3px solid var(--red); position:sticky; top:0; z-index:100; }
  .hdr-left { display:flex; align-items:center; gap:18px; }
  .hdr-bar { width:4px; height:26px; background:var(--red); border-radius:2px; }
  .hdr-title { font-family:'Barlow Condensed',sans-serif; font-weight:800; font-size:17px; color:#fff; letter-spacing:.04em; text-transform:uppercase; line-height:1.1; }
  .hdr-sub { font-family:'Barlow Condensed',sans-serif; font-size:10px; color:#666; letter-spacing:.14em; text-transform:uppercase; }
  .hdr-sep { width:1px; height:26px; background:#303030; }
  .hdr-meta { font-family:'JetBrains Mono',monospace; font-size:11px; color:#666; }
  .hdr-actions { display:flex; gap:8px; }

  .btn { display:inline-flex; align-items:center; gap:6px; padding:7px 13px; border-radius:3px; border:none; cursor:pointer; font-family:'Barlow Condensed',sans-serif; font-size:13px; font-weight:600; letter-spacing:.05em; text-transform:uppercase; transition:all .14s; }
  .btn-ghost { background:transparent; color:#999; border:1px solid #383838; }
  .btn-ghost:hover { border-color:#777; color:#fff; }
  .btn-red { background:var(--red); color:#fff; }
  .btn-red:hover { background:var(--red-dk); }
  .btn-outline { background:transparent; color:var(--red); border:1px solid var(--red); }
  .btn-outline:hover { background:var(--red); color:#fff; }
  .btn-light { background:var(--bg); color:var(--charcoal); border:1px solid var(--border); }
  .btn-light:hover { border-color:var(--border-dk); }

  /* â”€â”€ LAYOUT â”€â”€ */
  .main { display:flex; height:calc(100vh - 57px); }

  /* â”€â”€ SIDEBAR â”€â”€ */
  .sidebar { width:226px; flex-shrink:0; background:var(--sidebar); overflow-y:auto; display:flex; flex-direction:column; }
  .sb-head { padding:16px 18px 12px; border-bottom:1px solid #272727; }
  .sb-head-lbl { font-family:'Barlow Condensed',sans-serif; font-size:10px; color:#444; text-transform:uppercase; letter-spacing:.14em; margin-bottom:3px; }
  .sb-head-val { font-family:'Barlow Condensed',sans-serif; font-size:13px; color:#777; }
  .sb-sec { padding:12px 0 4px; }
  .sb-lbl { font-family:'Barlow Condensed',sans-serif; font-size:10px; color:#404040; text-transform:uppercase; letter-spacing:.14em; padding:0 18px 8px; }
  .mach-item { display:flex; align-items:center; justify-content:space-between; padding:10px 18px; cursor:pointer; border-left:3px solid transparent; transition:all .12s; }
  .mach-item:hover { background:var(--sidebar-h); }
  .mach-item.active { background:#202020; border-left-color:var(--red); }
  .mach-left { display:flex; align-items:center; gap:10px; min-width:0; }
  .mach-pip { width:3px; height:22px; border-radius:2px; flex-shrink:0; }
  .mach-name { font-family:'Barlow Condensed',sans-serif; font-size:14px; font-weight:600; color:#aaa; }
  .mach-item.active .mach-name { color:#fff; }
  .mach-code { font-family:'JetBrains Mono',monospace; font-size:10px; color:#484848; }
  .mach-del { width:20px; height:20px; border-radius:2px; border:1px solid #2e2e2e; background:transparent; cursor:pointer; display:none; align-items:center; justify-content:center; color:#444; font-size:10px; transition:all .12s; flex-shrink:0; }
  .mach-item:hover .mach-del { display:flex; }
  .mach-del:hover { color:var(--red); border-color:var(--red); }
  .sb-add { display:flex; align-items:center; gap:8px; padding:11px 18px; cursor:pointer; color:#404040; font-family:'Barlow Condensed',sans-serif; font-size:12px; text-transform:uppercase; letter-spacing:.08em; border-top:1px solid #222; margin-top:6px; transition:color .12s; }
  .sb-add:hover { color:var(--red); }
  .sb-plus { width:16px; height:16px; border:1px solid currentColor; border-radius:2px; display:flex; align-items:center; justify-content:center; font-size:11px; flex-shrink:0; }

  /* â”€â”€ CONTENT â”€â”€ */
  .content { flex:1; overflow-y:auto; padding:22px 26px; background:var(--bg); }

  /* â”€â”€ MACHINE HEADER â”€â”€ */
  .mach-hdr { display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:20px; padding-bottom:18px; border-bottom:2px solid var(--border); flex-wrap:wrap; gap:12px; }
  .mach-hdr-l { display:flex; align-items:center; gap:12px; }
  .mach-accent { width:5px; height:48px; border-radius:3px; flex-shrink:0; }
  .mach-big-title { font-family:'Barlow Condensed',sans-serif; font-weight:800; font-size:26px; text-transform:uppercase; letter-spacing:.03em; line-height:1; }
  .mach-big-sub { font-family:'JetBrains Mono',monospace; font-size:11px; color:var(--muted); margin-top:5px; letter-spacing:.04em; }

  /* â”€â”€ STATUS STRIP â”€â”€ */
  .stat-strip { display:flex; background:var(--surface); border:1px solid var(--border); border-radius:4px; overflow:hidden; margin-bottom:20px; box-shadow:var(--shadow-sm); }
  .stat-cell { flex:1; padding:13px 16px; text-align:center; border-right:1px solid var(--border); }
  .stat-cell:last-child { border-right:none; }
  .stat-lbl { font-family:'Barlow Condensed',sans-serif; font-size:10px; text-transform:uppercase; letter-spacing:.1em; color:var(--muted); margin-bottom:4px; }
  .stat-val { font-family:'Barlow Condensed',sans-serif; font-size:24px; font-weight:800; color:var(--charcoal); }
  .stat-val.r { color:var(--red); }
  .stat-val.g { color:var(--green); }
  .stat-val.m { color:var(--muted); }

  /* â”€â”€ MONTH BAR â”€â”€ */
  .month-bar { display:flex; gap:4px; margin-bottom:20px; align-items:center; flex-wrap:wrap; }
  .month-lbl { font-family:'Barlow Condensed',sans-serif; font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:.1em; margin-right:6px; }
  .mpill { padding:5px 10px; border-radius:2px; font-size:12px; cursor:pointer; background:var(--surface); border:1px solid var(--border); color:var(--muted); transition:all .12s; font-family:'Barlow Condensed',sans-serif; font-weight:600; letter-spacing:.05em; text-transform:uppercase; }
  .mpill:hover { border-color:var(--red); color:var(--red); }
  .mpill.active { background:var(--red); border-color:var(--red); color:#fff; }
  .mpill.filled { border-color:var(--border-dk); color:var(--grey); }

  /* â”€â”€ KPI CARDS â”€â”€ */
  .kpi-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(210px,1fr)); gap:12px; margin-bottom:22px; }
  .kpi-card { background:var(--card); border:1px solid var(--border); border-radius:4px; padding:16px 18px; box-shadow:var(--shadow-sm); position:relative; overflow:hidden; transition:box-shadow .18s; }
  .kpi-card:hover { box-shadow:var(--shadow); }
  .kpi-card-stripe { position:absolute; left:0; top:0; bottom:0; width:3px; }
  .kpi-code { font-family:'JetBrains Mono',monospace; font-size:10px; color:var(--muted); margin-bottom:3px; letter-spacing:.06em; }
  .kpi-name { font-family:'Barlow Condensed',sans-serif; font-size:12px; font-weight:700; color:var(--grey); text-transform:uppercase; letter-spacing:.08em; margin-bottom:10px; }
  .kpi-val { font-family:'Barlow Condensed',sans-serif; font-weight:800; font-size:32px; line-height:1; color:var(--charcoal); }
  .kpi-unit-lbl { font-size:11px; color:var(--muted); margin-top:2px; }
  .kpi-row { display:flex; gap:10px; margin-top:10px; padding-top:10px; border-top:1px solid var(--border); }
  .kpi-row-item { flex:1; }
  .kri-lbl { font-size:9px; color:var(--muted); text-transform:uppercase; letter-spacing:.08em; margin-bottom:1px; font-family:'Barlow Condensed',sans-serif; }
  .kri-val { font-family:'Barlow Condensed',sans-serif; font-weight:700; font-size:14px; }
  .kri-val.good { color:var(--green); }
  .kri-val.bad  { color:var(--red); }
  .kri-val.neu  { color:var(--muted); }
  .kpi-prog { height:3px; background:var(--bg); border-radius:2px; margin-top:10px; }
  .kpi-prog-bar { height:100%; border-radius:2px; transition:width .5s; }

  /* â”€â”€ SECTION HDR â”€â”€ */
  .sec-hdr { display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; }
  .sec-title { font-family:'Barlow Condensed',sans-serif; font-weight:700; font-size:14px; text-transform:uppercase; letter-spacing:.1em; color:var(--charcoal); display:flex; align-items:center; gap:10px; }
  .sec-title::before { content:''; width:3px; height:14px; background:var(--red); border-radius:2px; }
  .sec-tag { font-family:'JetBrains Mono',monospace; font-size:10px; color:var(--muted); background:var(--bg); border:1px solid var(--border); padding:2px 8px; border-radius:2px; font-weight:400; text-transform:none; letter-spacing:.04em; }

  /* â”€â”€ VIEW TABS â”€â”€ */
  .vtabs { display:flex; border:1px solid var(--border); border-radius:3px; overflow:hidden; }
  .vtab { padding:5px 13px; font-size:12px; cursor:pointer; color:var(--muted); border:none; background:var(--surface); transition:all .12s; font-family:'Barlow Condensed',sans-serif; font-weight:600; letter-spacing:.06em; text-transform:uppercase; border-right:1px solid var(--border); }
  .vtab:last-child { border-right:none; }
  .vtab.active { background:var(--charcoal); color:#fff; }
  .vtab:hover:not(.active) { background:var(--bg); }

  /* â”€â”€ CHARTS â”€â”€ */
  .charts-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:13px; margin-bottom:22px; }
  @media (max-width:1100px){.charts-grid{grid-template-columns:1fr;}}
  .chart-card { background:var(--card); border:1px solid var(--border); border-radius:4px; padding:16px 18px; box-shadow:var(--shadow-sm); }
  .chart-title { font-family:'Barlow Condensed',sans-serif; font-size:13px; font-weight:700; text-transform:uppercase; letter-spacing:.08em; color:var(--charcoal); margin-bottom:3px; }
  .chart-sub { font-size:11px; color:var(--muted); margin-bottom:13px; }
  .chart-wrap { position:relative; height:185px; }

  /* â”€â”€ TABLE â”€â”€ */
  .tbl-wrap { background:var(--card); border:1px solid var(--border); border-radius:4px; overflow:hidden; box-shadow:var(--shadow-sm); margin-bottom:22px; }
  .tbl-bar { display:flex; align-items:center; justify-content:space-between; padding:11px 16px; border-bottom:1px solid var(--border); background:#f9f8f6; }
  .tbl-bar-title { font-family:'Barlow Condensed',sans-serif; font-size:12px; font-weight:700; text-transform:uppercase; letter-spacing:.1em; color:var(--charcoal); }
  table { width:100%; border-collapse:collapse; }
  thead tr { background:#f5f4f2; }
  th { padding:9px 14px; font-size:10px; color:var(--muted); text-transform:uppercase; letter-spacing:.1em; text-align:left; border-bottom:2px solid var(--border); font-family:'Barlow Condensed',sans-serif; font-weight:700; white-space:nowrap; }
  th.r { text-align:right; }
  td { padding:10px 14px; font-size:13px; border-bottom:1px solid var(--border); }
  td.r { text-align:right; font-family:'JetBrains Mono',monospace; font-size:11px; }
  td.code { font-family:'JetBrains Mono',monospace; font-size:11px; color:var(--muted); }
  tr:last-child td { border-bottom:none; }
  tr:hover td { background:#fafaf8; }
  .badge { display:inline-flex; align-items:center; gap:4px; padding:3px 8px; border-radius:2px; font-family:'Barlow Condensed',sans-serif; font-size:12px; font-weight:700; letter-spacing:.04em; }
  .bg { background:var(--green-bg); color:var(--green); }
  .br { background:var(--red-lt); color:var(--red); }
  .bm { background:#efefed; color:var(--muted); }

  /* â”€â”€ MODALS â”€â”€ */
  .modal-bg { display:none; position:fixed; inset:0; background:rgba(10,10,10,.55); z-index:1000; align-items:center; justify-content:center; backdrop-filter:blur(2px); }
  .modal-bg.open { display:flex; }
  .modal { background:var(--surface); border:1px solid var(--border); border-radius:4px; padding:26px 28px; width:520px; max-width:95vw; max-height:90vh; overflow-y:auto; box-shadow:var(--shadow-lg); }
  .mod-title { font-family:'Barlow Condensed',sans-serif; font-weight:800; font-size:20px; text-transform:uppercase; letter-spacing:.04em; color:var(--charcoal); margin-bottom:4px; }
  .mod-sub { font-size:12px; color:var(--muted); margin-bottom:20px; }
  .mod-div { height:1px; background:var(--border); margin:16px 0; }
  .frow { margin-bottom:13px; }
  .flbl { font-family:'Barlow Condensed',sans-serif; font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:.1em; margin-bottom:5px; display:block; font-weight:700; }
  .finp { width:100%; padding:9px 12px; background:var(--bg); border:1px solid var(--border); border-radius:3px; color:var(--text); font-family:'Barlow',sans-serif; font-size:14px; outline:none; transition:border-color .13s; }
  .finp:focus { border-color:var(--charcoal); background:#fff; }
  .frow2 { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  .mod-foot { display:flex; justify-content:flex-end; gap:8px; margin-top:20px; }
  .kpi-fl { border:1px solid var(--border); border-radius:3px; overflow:hidden; margin-bottom:10px; }
  .kpi-fr { display:grid; grid-template-columns:65px 1fr 80px 55px 75px 85px 26px; gap:5px; padding:7px 10px; align-items:center; border-bottom:1px solid var(--border); }
  .kpi-fr:last-child { border-bottom:none; }
  .kpi-fr.kh { background:#f5f4f2; font-size:10px; color:var(--muted); text-transform:uppercase; letter-spacing:.08em; font-family:'Barlow Condensed',sans-serif; font-weight:700; }
  .kfi { background:#fff; border:1px solid var(--border); border-radius:2px; color:var(--text); font-family:'Barlow',sans-serif; font-size:12px; padding:4px 6px; width:100%; transition:border-color .12s; }
  .kfi:focus { outline:none; border-color:var(--charcoal); }
  .kdel { width:22px; height:22px; border-radius:2px; border:1px solid var(--border); background:transparent; cursor:pointer; color:var(--muted); font-size:10px; transition:all .12s; display:flex; align-items:center; justify-content:center; }
  .kdel:hover { color:var(--red); border-color:var(--red); }
  select.finp,select.kfi { appearance:none; background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='%237a7a7a' stroke-width='2.5'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:right 8px center; padding-right:24px; }

  /* â”€â”€ IMPORT â”€â”€ */
  .import-zone { border:2px dashed var(--border-dk); border-radius:4px; padding:34px 22px; text-align:center; cursor:pointer; transition:all .18s; margin-bottom:14px; background:var(--bg); }
  .import-zone:hover,.import-zone.drag { border-color:var(--red); background:var(--red-lt); }
  .imp-icon { font-size:30px; margin-bottom:10px; }
  .imp-title { font-family:'Barlow Condensed',sans-serif; font-size:15px; font-weight:700; text-transform:uppercase; letter-spacing:.06em; color:var(--charcoal); margin-bottom:4px; }
  .imp-sub { font-size:12px; color:var(--muted); }

  /* â”€â”€ DATA ENTRY â”€â”€ */
  .mgrid { display:grid; grid-template-columns:repeat(12,1fr); gap:3px; }
  .mci { background:var(--bg); border:1px solid var(--border); border-radius:2px; color:var(--text); font-family:'JetBrains Mono',monospace; font-size:10px; padding:5px 3px; width:100%; text-align:center; transition:border-color .12s; }
  .mci:focus { outline:none; border-color:var(--charcoal); background:#fff; }
  .mhrow { display:grid; grid-template-columns:repeat(12,1fr); gap:3px; margin-bottom:3px; }
  .mhc { font-size:9px; color:var(--muted); text-align:center; font-family:'Barlow Condensed',sans-serif; text-transform:uppercase; letter-spacing:.08em; font-weight:700; }
  .dsec { font-family:'Barlow Condensed',sans-serif; font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:.1em; color:var(--muted); margin-bottom:3px; margin-top:7px; }

  /* â”€â”€ TOAST â”€â”€ */
  .toast { position:fixed; bottom:20px; right:20px; z-index:9999; background:var(--charcoal); color:#fff; border-radius:3px; padding:10px 16px; font-size:13px; border-left:3px solid var(--red); transform:translateY(60px); opacity:0; transition:all .24s; font-family:'Barlow',sans-serif; }
  .toast.show { transform:translateY(0); opacity:1; }
  .toast.success { border-left-color:var(--green); }

  /* â”€â”€ EMPTY â”€â”€ */
  .empty { text-align:center; padding:80px 20px; }
  .empty-ico { font-size:44px; opacity:.2; filter:grayscale(1); margin-bottom:14px; }
  .empty-title { font-family:'Barlow Condensed',sans-serif; font-size:20px; font-weight:800; text-transform:uppercase; letter-spacing:.06em; color:var(--charcoal); margin-bottom:6px; }
  .empty-sub { font-size:13px; color:var(--muted); margin-bottom:18px; }

  ::-webkit-scrollbar{width:5px;height:5px;}
  ::-webkit-scrollbar-track{background:transparent;}
  ::-webkit-scrollbar-thumb{background:#ccc;border-radius:4px;}
  .sidebar::-webkit-scrollbar-thumb{background:#2e2e2e;}
</style>
</head>
<body>

<header class="header">
  <div class="hdr-left">
    <div class="hdr-bar"></div>
    <div>
      <div class="hdr-title">Oklahoma City</div>
      <div class="hdr-sub">Manufacturing KPI Dashboard</div>
    </div>
    <div class="hdr-sep"></div>
    <div class="hdr-meta">FY 2026</div>
  </div>
  <div class="hdr-actions">
    <button class="btn btn-ghost" onclick="openImportModal()">
      <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
      Import
    </button>
    <button class="btn btn-ghost" onclick="exportData()">
      <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
      Export
    </button>
    <button class="btn btn-red" onclick="openAddMachineModal()">
      <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      Add Machine
    </button>
  </div>
</header>

<div class="main">
  <aside class="sidebar">
    <div class="sb-head">
      <div class="sb-head-lbl">Fleet</div>
      <div class="sb-head-val" id="machCount">0 machines</div>
    </div>
    <div class="sb-sec">
      <div class="sb-lbl">Select Machine</div>
      <div id="machList"></div>
      <div class="sb-add" onclick="openAddMachineModal()">
        <div class="sb-plus">+</div>
        Add Machine
      </div>
    </div>
  </aside>

  <main class="content">
    <div class="empty" id="emptyState">
      <div class="empty-ico">âš™</div>
      <div class="empty-title">No Machine Selected</div>
      <div class="empty-sub">Select a machine from the sidebar or add a new one</div>
      <button class="btn btn-red" onclick="openAddMachineModal()">
        <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Add First Machine
      </button>
    </div>
    <div id="dashContent" style="display:none"></div>
  </main>
</div>

<!-- IMPORT MODAL -->
<div class="modal-bg" id="importModal">
  <div class="modal">
    <div class="mod-title">Import Excel Data</div>
    <div class="mod-sub">Accepts the KPI dashboard format â€” CY Actual, CY Target, PY Actual sheets</div>
    <div class="import-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
      <div class="imp-icon">ðŸ“‚</div>
      <div class="imp-title">Drop XLSX Here</div>
      <div class="imp-sub">or click to browse Â· .xlsx / .xls</div>
    </div>
    <input type="file" id="fileInput" accept=".xlsx,.xls" style="display:none" onchange="handleFileSelect(event)">
    <div id="importStatus" style="font-size:12px;color:var(--muted);"></div>
    <div class="mod-foot">
      <button class="btn btn-light" onclick="closeModal('importModal')">Cancel</button>
    </div>
  </div>
</div>

<!-- ADD/EDIT MACHINE MODAL -->
<div class="modal-bg" id="addMachModal">
  <div class="modal" style="width:700px">
    <div class="mod-title" id="machModalTitle">Add New Machine</div>
    <div class="mod-sub">Define machine identity and KPI structure</div>
    <div class="frow2">
      <div class="frow"><label class="flbl">Machine Name</label><input class="finp" id="mName" placeholder="e.g. Apstar"></div>
      <div class="frow"><label class="flbl">Machine Code</label><input class="finp" id="mCode" placeholder="e.g. 210"></div>
    </div>
    <div class="frow"><label class="flbl">Full Label</label><input class="finp" id="mLabel" placeholder="e.g. 210 APSTAR 66x110 RDC"></div>
    <div class="frow"><label class="flbl">Accent Color</label><input type="color" class="finp" id="mColor" value="#c8102e" style="height:40px;padding:4px 8px;cursor:pointer;"></div>
    <div class="mod-div"></div>
    <div style="font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:12px;text-transform:uppercase;letter-spacing:.1em;color:var(--charcoal);margin-bottom:10px;">KPI Definitions</div>
    <div class="kpi-fl" id="kpiFL"></div>
    <button class="btn btn-light" style="font-size:11px;padding:5px 11px;margin-top:6px;" onclick="addKpiRow()">+ Add KPI</button>
    <div class="mod-foot">
      <button class="btn btn-light" onclick="closeModal('addMachModal')">Cancel</button>
      <button class="btn btn-red" onclick="saveMachine()">Save Machine</button>
    </div>
  </div>
</div>

<!-- DATA ENTRY MODAL -->
<div class="modal-bg" id="dataModal">
  <div class="modal" style="width:820px">
    <div class="mod-title" id="dataModalTitle">Enter Monthly Data</div>
    <div class="mod-sub">Fill values per month. Leave blank if unavailable.</div>
    <div id="dataModalBody"></div>
    <div class="mod-foot">
      <button class="btn btn-light" onclick="closeModal('dataModal')">Cancel</button>
      <button class="btn btn-red" onclick="saveMonthlyData()">Save Data</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const MONTHS=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
const WEEKS=['W1','W2','W3','W4','W5','W6','W7','W8','W9','W10','W11','W12','W13','W14','W15','W16','W17','W18','W19','W20','W21','W22','W23','W24','W25','W26','W27','W28','W29','W30','W31','W32','W33','W34','W35','W36','W37','W38','W39','W40','W41','W42','W43','W44','W45','W46','W47','W48','W49','W50','W51','W52'];
const QUARTERS=['Q1','Q2','Q3','Q4'];
const COLORS=['#c8102e','#2d2d2d','#b45309','#1a5276','#6b2fa0','#145a32','#7f1d1d','#1a3c6e'];
let state={machines:[],activeMachine:null,editingMachine:null};
window._activeMonth=4;
window._activePeriod=4;
window._viewMode='monthly'; // weekly, monthly, quarterly, yearly

function seedData(){
  state.machines=[
    { id:'apstar',name:'Apstar',code:'210',label:'210 APSTAR 66x110 RDC',color:'#c8102e',
      kpis:[{code:'101',name:'Setup Time',criteria:'Avg setup time per job/changeover',unit:'Avg',lowerBetter:true},{code:'102',name:'Downtime',criteria:'% of time APSTAR is down',unit:'%',lowerBetter:true},{code:'103',name:'Feeds/RunHr',criteria:'Avg feeds per actual run hour',unit:'Avg',lowerBetter:false},{code:'104',name:'Feeds/SchHr',criteria:'Avg feeds per scheduled hour',unit:'Avg',lowerBetter:false}],
      data:{
        weekly:{cyActual:{101:new Array(52).fill(null),102:new Array(52).fill(null),103:new Array(52).fill(null),104:new Array(52).fill(null)},cyTarget:{101:new Array(52).fill(.87),102:new Array(52).fill(2.4),103:new Array(52).fill(2.8),104:new Array(52).fill(null)},pyActual:{101:new Array(52).fill(null),102:new Array(52).fill(null),103:new Array(52).fill(null),104:new Array(52).fill(null)}},
        monthly:{cyActual:{101:[.82998,.81338,.75644,.74132,.78579,.78579,null,null,null,null,null,null],102:[2.376,2.44728,2.22703,2.07113,2.19540,2.06368,null,null,null,null,null,null],103:[3.0492,3.29314,3.09555,3.00268,3.12279,2.84174,null,null,null,null,null,null],104:[null,null,null,null,null,null,null,null,null,null,null,null]},cyTarget:{101:[.87,.87,.87,.87,.87,.87,.87,.87,.87,.87,.87,.87],102:[2.4,2.4,2.4,2.4,2.4,2.4,2.4,2.4,2.4,2.4,2.4,2.4],103:[2.8,2.8,2.8,2.8,2.8,2.8,2.8,2.8,2.8,2.8,2.8,2.8],104:[null,null,null,null,null,null,null,null,null,null,null,null]},pyActual:{101:[.7743,.87,.7134,.7482,.7308,.783,.8352,.783,.7569,.8091,.7308,.7134],102:[2.832,2.328,2.76,2.856,2.376,2.424,2.664,2.352,2.544,2.64,2.856,2.88],103:[3.248,3.192,2.968,2.828,3.332,3.192,2.996,2.8,3.276,2.66,3.332,2.912],104:[null,null,null,null,null,null,null,null,null,null,null,null]}},
        quarterly:{cyActual:{101:[.79993,.76622,null,null],102:[2.35010,2.12674,null,null],103:[3.14531,2.99074,null,null],104:[null,null,null,null]},cyTarget:{101:[.87,.87,.87,.87],102:[2.4,2.4,2.4,2.4],103:[2.8,2.8,2.8,2.8],104:[null,null,null,null]},pyActual:{101:[.78623,.77033,null,null],102:[2.64,2.54533,null,null],103:[3.13600,3.01467,null,null],104:[null,null,null,null]}},
        yearly:{cyActual:{101:[.78308],102:[2.23842],103:[3.06803],104:[null]},cyTarget:{101:[.87],102:[2.4],103:[2.8],104:[null]},pyActual:{101:[.77828],102:[2.59267],103:[3.07533],104:[null]}}
      }},
    { id:'serenco',name:'Serenco',code:'120',label:'120 SERENCO 55x110 FFG',color:'#2d2d2d',
      kpis:[{code:'201',name:'Setup Time',criteria:'Avg setup time per job/changeover',unit:'Avg',lowerBetter:true},{code:'202',name:'Downtime',criteria:'% of time Serenco is down',unit:'%',lowerBetter:true},{code:'203',name:'Feeds/RunHr',criteria:'Avg feeds per actual run hour',unit:'Avg',lowerBetter:false},{code:'204',name:'Feeds/SchHr',criteria:'Avg feeds per scheduled hour',unit:'Avg',lowerBetter:false}],
      data:{
        weekly:{cyActual:{201:new Array(52).fill(null),202:new Array(52).fill(null),203:new Array(52).fill(null),204:new Array(52).fill(null)},cyTarget:{201:new Array(52).fill(null),202:new Array(52).fill(.91),203:new Array(52).fill(.036),204:new Array(52).fill(.88)},pyActual:{201:new Array(52).fill(null),202:new Array(52).fill(null),203:new Array(52).fill(null),204:new Array(52).fill(null)}},
        monthly:{cyActual:{201:[null,null,null,null,null,null,null,null,null,null,null,null],202:[.74529,.74746,.82936,.882,.855,.864,null,null,null,null,null,null],203:[.039204,.042732,.046578,.043318,.045484,.0423,null,null,null,null,null,null],204:[.792,.7524,.782496,.766846,.774515,.836476,null,null,null,null,null,null]},cyTarget:{201:[null,null,null,null,null,null,null,null,null,null,null,null],202:[.91,.91,.91,.91,.91,.91,.91,.91,.91,.91,.91,.91],203:[.036,.036,.036,.036,.036,.036,.036,.036,.036,.036,.036,.036],204:[.88,.88,.88,.88,.88,.88,.88,.88,.88,.88,.88,.88]},pyActual:{201:[.9191,.9555,.7462,.8827,.728,.9464,.7644,.9282,.7735,.8281,.8099,.8463],202:[.04068,.03744,.03492,.03852,.04104,.03852,.0396,.04068,.04068,.03996,.03744,.03456],203:[.924,.7128,.9152,.7568,.7656,.88,.8272,.8712,.748,.7656,.7216,.9064],204:[null,null,null,null,null,null,null,null,null,null,null,null]}},
        quarterly:{cyActual:{201:[null,null,null,null],202:[.77404,.86700,null,null],203:[.042838,.043463,null,null],204:[.775632,.773651,null,null]},cyTarget:{201:[null,null,null,null],202:[.91,.91,.91,.91],203:[.036,.036,.036,.036],204:[.88,.88,.88,.88]},pyActual:{201:[.87360,.84630,null,null],202:[.03768,.03852,null,null],203:[.85267,.81488,null,null],204:[null,null,null,null]}},
        yearly:{cyActual:{201:[null],202:[.82052],203:[.043151],204:[.774642]},cyTarget:{201:[null],202:[.91],203:[.036],204:[.88]},pyActual:{201:[.85995],202:[.03810],203:[.83378],204:[null]}}
      }},
    { id:'mckinley',name:'McKinley',code:'220',label:'220 MCKINLEY 66x110 RDC',color:'#b45309',
      kpis:[{code:'301',name:'Setup Time',criteria:'Avg setup time per job/changeover',unit:'Avg',lowerBetter:true},{code:'302',name:'Downtime',criteria:'% of time McKinley is down',unit:'%',lowerBetter:true},{code:'303',name:'Feeds/RunHr',criteria:'Avg feeds per actual run hour',unit:'Avg',lowerBetter:false},{code:'304',name:'Feeds/SchHr',criteria:'Avg feeds per scheduled hour',unit:'Avg',lowerBetter:false}],
      data:{
        weekly:{cyActual:{301:new Array(52).fill(null),302:new Array(52).fill(null),303:new Array(52).fill(null),304:new Array(52).fill(null)},cyTarget:{301:new Array(52).fill(null),302:new Array(52).fill(null),303:new Array(52).fill(450),304:new Array(52).fill(.86)},pyActual:{301:new Array(52).fill(null),302:new Array(52).fill(null),303:new Array(52).fill(null),304:new Array(52).fill(null)}},
        monthly:{cyActual:{301:[null,null,null,null,null,null,null,null,null,null,null,null],302:[null,null,null,null,null,null,null,null,null,null,null,null],303:[392.85,392.85,373.21,347.08,319.32,328.9,null,null,null,null,null,null],304:[.75852,.77369,.71180,.73315,.66717,.60045,null,null,null,null,null,null]},cyTarget:{301:[null,null,null,null,null,null,null,null,null,null,null,null],302:[null,null,null,null,null,null,null,null,null,null,null,null],303:[450,450,450,450,450,450,450,450,450,450,450,450],304:[.86,.86,.86,.86,.86,.86,.86,.86,.86,.86,.86,.86]},pyActual:{301:[423,400.5,463.5,396,378,409.5,441,405,414,468,414,369],302:[.7052,.8342,.86,.6966,.7482,.8858,.86,.7568,.7052,.8858,.8686,.6966],303:[.8262,.7695,.6561,.8019,.6642,.729,.8262,.7128,.7128,.7047,.8019,.6804],304:[.6622,.6853,.6622,.616,.7392,.6853,.693,.7546,.77,.7854,.7546,.693]}},
        quarterly:{cyActual:{301:[null,null,null,null],302:[null,null,null,null],303:[386.30333,331.76667,null,null],304:[.74800,.70692,null,null]},cyTarget:{301:[null,null,null,null],302:[null,null,null,null],303:[450,450,450,450],304:[.86,.86,.86,.86]},pyActual:{301:[429,394.5,null,null],302:[.79973,.76120,null,null],303:[.75060,.71740,null,null],304:[.66590,.67262,null,null]}},
        yearly:{cyActual:{301:[null],302:[null],303:[359.03500],304:[.72746]},cyTarget:{301:[null],302:[null],303:[450],304:[.86]},pyActual:{301:[411.75],302:[.78047],303:[.73400],304:[.66926]}}
      }},
    { id:'ward',name:'Ward',code:'230',label:'230 WARD 66x110 RDC',color:'#1a5276',
      kpis:[{code:'401',name:'Setup Time',criteria:'Avg setup time per job/changeover',unit:'Avg',lowerBetter:true},{code:'402',name:'Downtime',criteria:'% of time Ward is down',unit:'%',lowerBetter:true},{code:'403',name:'Feeds/RunHr',criteria:'Avg feeds per actual run hour',unit:'Avg',lowerBetter:false},{code:'404',name:'Feeds/SchHr',criteria:'Avg feeds per scheduled hour',unit:'Avg',lowerBetter:false}],
      data:{
        weekly:{cyActual:{401:new Array(52).fill(null),402:new Array(52).fill(null),403:new Array(52).fill(null),404:new Array(52).fill(null)},cyTarget:{401:new Array(52).fill(.81),402:new Array(52).fill(.77),403:new Array(52).fill(.955),404:new Array(52).fill(null)},pyActual:{401:new Array(52).fill(null),402:new Array(52).fill(null),403:new Array(52).fill(null),404:new Array(52).fill(null)}},
        monthly:{cyActual:{401:[.67068,.69751,.74633,.75380,.82918,.87063,null,null,null,null,null,null],402:[.63063,.58018,.52216,.49083,.44666,.49132,null,null,null,null,null,null],403:[.83372,.76702,.74401,.77377,.78151,.81277,null,null,null,null,null,null],404:[null,null,null,null,null,null,null,null,null,null,null,null]},cyTarget:{401:[.81,.81,.81,.81,.81,.81,.81,.81,.81,.81,.81,.81],402:[.77,.77,.77,.77,.77,.77,.77,.77,.77,.77,.77,.77],403:[.955,.955,.955,.955,.955,.955,.955,.955,.955,.955,.955,.955],404:[null,null,null,null,null,null,null,null,null,null,null,null]},pyActual:{401:[null,null,null,null,null,null,null,null,null,null,null,null],402:[null,null,null,null,null,null,null,null,null,null,null,null],403:[null,null,null,null,null,null,null,null,null,null,null,null],404:[null,null,null,null,null,null,null,null,null,null,null,null]}},
        quarterly:{cyActual:{401:[.70484,.78454,null,null],402:[.57766,.47627,null,null],403:[.78158,.78913,null,null],404:[null,null,null,null]},cyTarget:{401:[.81,.81,.81,.81],402:[.77,.77,.77,.77],403:[.955,.955,.955,.955],404:[null,null,null,null]},pyActual:{401:[null,null,null,null],402:[null,null,null,null],403:[null,null,null,null],404:[null,null,null,null]}},
        yearly:{cyActual:{401:[.74469],402:[.52697],403:[.78536]},cyTarget:{401:[.81],402:[.77],403:[.955]},pyActual:{401:[null],402:[null],403:[null]}}
      }}
  ];
}

const f=(v,d=3)=>{ if(v===null||v===undefined||isNaN(v)) return 'â€”'; return Number(v).toLocaleString('en-US',{maximumFractionDigits:d}); };
function toast(msg,type='success'){const t=document.getElementById('toast');t.textContent=msg;t.className=`toast ${type} show`;setTimeout(()=>t.className='toast',3000);}

// â”€ SIDEBAR â”€
function renderSidebar(){
  const list=document.getElementById('machList');
  const cnt=document.getElementById('machCount');
  cnt.textContent=`${state.machines.length} machine${state.machines.length!==1?'s':''}`;
  list.innerHTML=state.machines.map(m=>`
    <div class="mach-item ${m.id===state.activeMachine?'active':''}" onclick="selectMachine('${m.id}')">
      <div class="mach-left">
        <div class="mach-pip" style="background:${m.color}"></div>
        <div><div class="mach-name">${m.name}</div><div class="mach-code">${m.code}</div></div>
      </div>
      <button class="mach-del" onclick="event.stopPropagation();deleteMachine('${m.id}')">âœ•</button>
    </div>`).join('');
}

function selectMachine(id){state.activeMachine=id;renderSidebar();renderDashboard();}
function deleteMachine(id){
  if(!confirm('Delete this machine and all its data?')) return;
  state.machines=state.machines.filter(m=>m.id!==id);
  if(state.activeMachine===id) state.activeMachine=null;
  renderSidebar();renderDashboard();toast('Machine deleted');
}

// â”€ DASHBOARD â”€
let charts={};

function renderDashboard(){
  const emp=document.getElementById('emptyState');
  const dash=document.getElementById('dashContent');
  if(!state.activeMachine){emp.style.display='';dash.style.display='none';return;}
  emp.style.display='none';dash.style.display='';
  const m=state.machines.find(x=>x.id===state.activeMachine);if(!m)return;
  Object.values(charts).forEach(c=>c.destroy());charts={};
  const mode=window._viewMode;
  const pi=window._activePeriod;
  
  // Get period labels based on mode
  let periodLabels, periodCount;
  if(mode==='weekly'){periodLabels=WEEKS;periodCount=52;}
  else if(mode==='monthly'){periodLabels=MONTHS;periodCount=12;}
  else if(mode==='quarterly'){periodLabels=QUARTERS;periodCount=4;}
  else{periodLabels=['2026'];periodCount=1;}
  
  dash.innerHTML=`
    <div class="mach-hdr">
      <div class="mach-hdr-l">
        <div class="mach-accent" style="background:${m.color}"></div>
        <div>
          <div class="mach-big-title">${m.label}</div>
          <div class="mach-big-sub">CODE: ${m.code} &nbsp;Â·&nbsp; ${m.kpis.length} KPIs &nbsp;Â·&nbsp; FY 2026</div>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn btn-outline" onclick="openDataModal('${m.id}')">
          <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
          Enter Data
        </button>
        <button class="btn btn-light" onclick="openEditMachine('${m.id}')">Edit Machine</button>
      </div>
    </div>
    
    <div style="display:flex;gap:10px;align-items:center;margin-bottom:16px;flex-wrap:wrap;">
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.1em;">View:</div>
      <div class="vtabs">
        <button class="vtab ${mode==='weekly'?'active':''}" onclick="switchViewMode('weekly')">Weekly</button>
        <button class="vtab ${mode==='monthly'?'active':''}" onclick="switchViewMode('monthly')">Monthly</button>
        <button class="vtab ${mode==='quarterly'?'active':''}" onclick="switchViewMode('quarterly')">Quarterly</button>
        <button class="vtab ${mode==='yearly'?'active':''}" onclick="switchViewMode('yearly')">Yearly</button>
      </div>
    </div>
    
    ${mode!=='yearly'?`<div class="month-bar">
      <span class="month-lbl">${mode==='weekly'?'Week':mode==='quarterly'?'Quarter':'Month'}:</span>
      ${periodLabels.map((lbl,i)=>{
        const has=m.kpis.some(k=>(m.data[mode].cyActual[k.code]||[])[i]!=null);
        return`<div class="mpill ${i===pi?'active':''}${has?' filled':''}" onclick="switchPeriod(${i})" id="pp${i}">${lbl}</div>`;
      }).join('')}
    </div>`:''}
    
    <div id="statStrip" class="stat-strip"></div>
    <div class="kpi-grid" id="kpiCards"></div>
    <div class="sec-hdr">
      <div class="sec-title">${mode==='weekly'?'Weekly':mode==='quarterly'?'Quarterly':mode==='yearly'?'Yearly':'Monthly'} Trends <span class="sec-tag">CY Actual Â· Target Â· PY</span></div>
      <div class="vtabs">
        <button class="vtab active" onclick="switchChartView('actual',this)">Actual</button>
        <button class="vtab" onclick="switchChartView('cumulative',this)">Cumulative</button>
      </div>
    </div>
    <div class="charts-grid" id="chartsGrid"></div>
    <div class="sec-hdr">
      <div class="sec-title">Performance Table <span class="sec-tag">${mode==='yearly'?'Year 2026':periodLabels[pi]+' 2026'}</span></div>
    </div>
    <div class="tbl-wrap">
      <div class="tbl-bar"><div class="tbl-bar-title">${m.name} Â· All KPIs</div><div style="font-size:11px;color:var(--muted);font-family:'JetBrains Mono',monospace">Period: ${mode==='yearly'?'Year 2026':periodLabels[pi]}</div></div>
      <div id="tblBody"></div>
    </div>`;
  renderStrip(m,pi,mode); renderCards(m,pi,mode); renderCharts(m,mode); renderTable(m,pi,mode);
  window._activeMachine=m;
}

function renderStrip(m,pi,mode){
  const el=document.getElementById('statStrip');if(!el)return;
  let on=0,below=0,nd=0;
  m.kpis.forEach(kpi=>{const a=(m.data[mode].cyActual[kpi.code]||[])[pi],t=(m.data[mode].cyTarget[kpi.code]||[])[pi];if(a==null||t==null){nd++;return;}const good=kpi.lowerBetter?a/t*100<=100:a/t*100>=100;good?on++:below++;});
  el.innerHTML=`<div class="stat-cell"><div class="stat-lbl">On / Above Target</div><div class="stat-val g">${on}</div></div><div class="stat-cell"><div class="stat-lbl">Below Target</div><div class="stat-val r">${below}</div></div><div class="stat-cell"><div class="stat-lbl">No Data</div><div class="stat-val m">${nd}</div></div><div class="stat-cell"><div class="stat-lbl">Total KPIs</div><div class="stat-val">${m.kpis.length}</div></div><div class="stat-cell"><div class="stat-lbl">Machine</div><div class="stat-val" style="font-size:16px">${m.name}</div></div>`;
}

function renderCards(m,pi,mode){
  const el=document.getElementById('kpiCards');if(!el)return;
  el.innerHTML=m.kpis.map(kpi=>{
    const a=(m.data[mode].cyActual[kpi.code]||[])[pi]??null;
    const t=(m.data[mode].cyTarget[kpi.code]||[])[pi]??null;
    const p=(m.data[mode].pyActual[kpi.code]||[])[pi]??null;
    const vsT=(a!=null&&t!=null&&t!==0)?a/t*100:null;
    const vsP=(a!=null&&p!=null&&p!==0)?a/p*100:null;
    const good=vsT!=null?(kpi.lowerBetter?vsT<=100:vsT>=100):null;
    const sc=good===null?'var(--grey-lt)':good?'var(--green)':'var(--red)';
    const vc=good===null?'neu':good?'good':'bad';
    const bw=vsT!=null?Math.min(Math.abs(vsT),150):0;
    const pvGood=vsP!=null?(kpi.lowerBetter?vsP<=100:vsP>=100):null;
    const pvc=pvGood===null?'neu':pvGood?'good':'bad';
    return`<div class="kpi-card">
      <div class="kpi-card-stripe" style="background:${sc}"></div>
      <div class="kpi-code">${kpi.code} Â· ${kpi.unit}</div>
      <div class="kpi-name">${kpi.name}</div>
      <div class="kpi-val">${f(a)}</div>
      <div class="kpi-unit-lbl">${kpi.criteria}</div>
      <div class="kpi-row">
        <div class="kpi-row-item"><div class="kri-lbl">vs Target</div><div class="kri-val ${vc}">${vsT!=null?vsT.toFixed(1)+'%':'â€”'}</div></div>
        <div class="kpi-row-item"><div class="kri-lbl">vs PY</div><div class="kri-val ${pvc}">${vsP!=null?vsP.toFixed(1)+'%':'â€”'}</div></div>
        <div class="kpi-row-item"><div class="kri-lbl">Target</div><div class="kri-val neu">${f(t)}</div></div>
      </div>
      <div class="kpi-prog"><div class="kpi-prog-bar" style="width:${bw}%;background:${sc}"></div></div>
    </div>`;
  }).join('');
}

function switchPeriod(idx){
  window._activePeriod=idx;
  document.querySelectorAll('.mpill').forEach((p,i)=>{p.classList.toggle('active',i===idx);});
  const m=window._activeMachine;
  const mode=window._viewMode;
  if(m){renderCards(m,idx,mode);renderStrip(m,idx,mode);renderTable(m,idx,mode);}
}

function switchViewMode(newMode){
  window._viewMode=newMode;
  window._activePeriod=newMode==='yearly'?0:newMode==='quarterly'?1:newMode==='weekly'?20:4;
  renderDashboard();
}

function renderCharts(m,mode){
  const grid=document.getElementById('chartsGrid');if(!grid)return;
  const periodLabels=mode==='weekly'?WEEKS:mode==='quarterly'?QUARTERS:mode==='yearly'?['2026']:MONTHS;
  grid.innerHTML=m.kpis.map(kpi=>`<div class="chart-card"><div class="chart-title">${kpi.code} Â· ${kpi.name}</div><div class="chart-sub">${kpi.criteria}</div><div class="chart-wrap"><canvas id="ch_${kpi.code}"></canvas></div></div>`).join('');
  m.kpis.forEach(kpi=>{
    const ctx=document.getElementById(`ch_${kpi.code}`);if(!ctx)return;
    const cy=m.data[mode].cyActual[kpi.code]||[],tgt=m.data[mode].cyTarget[kpi.code]||[],py=m.data[mode].pyActual[kpi.code]||[];
    charts[kpi.code]=new Chart(ctx,{type:'line',data:{labels:periodLabels,datasets:[
      {label:'CY Actual',data:cy,borderColor:m.color,backgroundColor:m.color+'18',fill:true,tension:.4,borderWidth:2.5,pointRadius:mode==='weekly'?2:4,pointHoverRadius:6,pointBackgroundColor:m.color,pointBorderColor:'#fff',pointBorderWidth:2},
      {label:'Target',data:tgt,borderColor:'#bbb',borderDash:[5,4],fill:false,tension:.3,borderWidth:1.5,pointRadius:mode==='weekly'?1:2,pointBackgroundColor:'#bbb'},
      {label:'PY Actual',data:py,borderColor:'#ddd',fill:false,tension:.4,borderWidth:1.5,pointRadius:mode==='weekly'?1:2,pointBackgroundColor:'#ddd'}
    ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#888',font:{family:'Barlow',size:11},boxWidth:12,padding:14}},tooltip:{backgroundColor:'#1a1a1a',titleFont:{family:'Barlow Condensed',size:13},bodyFont:{family:'JetBrains Mono',size:11},padding:10,cornerRadius:2}},scales:{x:{grid:{color:'#eeece8'},ticks:{color:'#bbb',font:{family:'Barlow Condensed',size:mode==='weekly'?8:11},maxRotation:mode==='weekly'?90:0,minRotation:mode==='weekly'?45:0}},y:{grid:{color:'#eeece8'},ticks:{color:'#bbb',font:{family:'JetBrains Mono',size:10}}}}}});
  });
}

function switchChartView(chartMode,btn){
  document.querySelectorAll('.vtab').forEach(t=>t.classList.remove('active'));btn.classList.add('active');
  const m=state.machines.find(x=>x.id===state.activeMachine);if(!m)return;
  const mode=window._viewMode;
  m.kpis.forEach(kpi=>{
    const c=charts[kpi.code];if(!c)return;
    if(chartMode==='actual'){c.data.datasets[0].data=m.data[mode].cyActual[kpi.code]||[];c.data.datasets[2].data=m.data[mode].pyActual[kpi.code]||[];}
    else{c.data.datasets[0].data=cumAvg(m.data[mode].cyActual[kpi.code]||[]);c.data.datasets[2].data=cumAvg(m.data[mode].pyActual[kpi.code]||[]);}
    c.update();
  });
}

function cumAvg(arr){let s=0,c=0;return arr.map(v=>{if(v==null)return null;s+=v;c++;return s/c;});}

function renderTable(m,pi,mode){
  const el=document.getElementById('tblBody');if(!el)return;
  const rows=m.kpis.map(kpi=>{
    const a=(m.data[mode].cyActual[kpi.code]||[])[pi]??null;
    const t=(m.data[mode].cyTarget[kpi.code]||[])[pi]??null;
    const p=(m.data[mode].pyActual[kpi.code]||[])[pi]??null;
    const vsT=(a!=null&&t!=null&&t!==0)?a/t*100:null;
    const vsP=(a!=null&&p!=null&&p!==0)?a/p*100:null;
    const good=vsT!=null?(kpi.lowerBetter?vsT<=100:vsT>=100):null;
    const arrow=good===null?'':good?'â–²':'â–¼';
    const bc=good===null?'bm':good?'bg':'br';
    return`<tr><td class="code">${kpi.code}</td><td style="font-weight:500">${kpi.name}</td><td style="color:var(--muted);font-size:12px">${kpi.criteria}</td><td class="r" style="color:var(--muted)">${kpi.unit}</td><td class="r" style="font-weight:600">${f(a)}</td><td class="r">${f(t)}</td><td class="r">${f(p)}</td><td class="r"><span class="badge ${bc}">${arrow} ${vsT!=null?vsT.toFixed(1)+'%':'â€”'}</span></td><td class="r" style="color:var(--muted)">${vsP!=null?vsP.toFixed(1)+'%':'â€”'}</td></tr>`;
  }).join('');
  el.innerHTML=`<table><thead><tr><th>Code</th><th>KPI</th><th>Criteria</th><th class="r">Unit</th><th class="r">Actual</th><th class="r">Target</th><th class="r">PY Actual</th><th class="r">Act/Target</th><th class="r">Act/PY</th></tr></thead><tbody>${rows}</tbody></table>`;
}

// â”€ MACHINE MODAL â”€
let kpiRows=[];

function openAddMachineModal(){
  state.editingMachine=null;
  document.getElementById('machModalTitle').textContent='Add New Machine';
  document.getElementById('mName').value='';document.getElementById('mCode').value='';
  document.getElementById('mLabel').value='';document.getElementById('mColor').value=COLORS[state.machines.length%COLORS.length];
  kpiRows=[{code:'',name:'Setup Time',criteria:'Avg setup time per job/changeover',unit:'Avg',target:'',lowerBetter:true},{code:'',name:'Downtime',criteria:'% of time machine is down',unit:'%',target:'',lowerBetter:true},{code:'',name:'Feeds/RunHr',criteria:'Avg feeds per actual run hour',unit:'Avg',target:'',lowerBetter:false},{code:'',name:'Feeds/SchHr',criteria:'Avg feeds per scheduled hour',unit:'Avg',target:'',lowerBetter:false}];
  renderKFL();document.getElementById('addMachModal').classList.add('open');
}

function openEditMachine(id){
  const m=state.machines.find(x=>x.id===id);if(!m)return;
  state.editingMachine=id;
  document.getElementById('machModalTitle').textContent='Edit Machine';
  document.getElementById('mName').value=m.name;document.getElementById('mCode').value=m.code;
  document.getElementById('mLabel').value=m.label;document.getElementById('mColor').value=m.color;
  kpiRows=m.kpis.map(k=>({...k}));
  renderKFL();document.getElementById('addMachModal').classList.add('open');
}

function renderKFL(){
  const el=document.getElementById('kpiFL');
  el.innerHTML=`<div class="kpi-fr kh"><div>Code</div><div>Name</div><div>Criteria</div><div>Unit</div><div>Target</div><div>Direction</div><div></div></div>`+kpiRows.map((r,i)=>`
    <div class="kpi-fr">
      <input class="kfi" value="${r.code}" placeholder="101" oninput="kpiRows[${i}].code=this.value">
      <input class="kfi" value="${r.name}" placeholder="KPI Name" oninput="kpiRows[${i}].name=this.value">
      <input class="kfi" value="${r.criteria}" placeholder="Description" oninput="kpiRows[${i}].criteria=this.value">
      <input class="kfi" value="${r.unit}" placeholder="Avg" style="text-align:center" oninput="kpiRows[${i}].unit=this.value">
      <input class="kfi" value="${r.target||''}" placeholder="0.87" type="number" step="any" oninput="kpiRows[${i}].target=parseFloat(this.value)||null">
      <select class="kfi" onchange="kpiRows[${i}].lowerBetter=this.value==='true'">
        <option value="true" ${r.lowerBetter?'selected':''}>â†“ Better</option>
        <option value="false" ${!r.lowerBetter?'selected':''}>â†‘ Better</option>
      </select>
      <button class="kdel" onclick="kpiRows.splice(${i},1);renderKFL()">âœ•</button>
    </div>`).join('');
}

function addKpiRow(){kpiRows.push({code:'',name:'New KPI',criteria:'',unit:'Avg',target:null,lowerBetter:false});renderKFL();}

function saveMachine(){
  const name=document.getElementById('mName').value.trim();
  const code=document.getElementById('mCode').value.trim();
  const label=document.getElementById('mLabel').value.trim();
  const color=document.getElementById('mColor').value;
  if(!name){toast('Machine name is required','error');return;}
  const kpis=kpiRows.filter(r=>r.name).map(r=>({code:r.code||String(Math.floor(Math.random()*900)+100),name:r.name,criteria:r.criteria,unit:r.unit,lowerBetter:r.lowerBetter}));
  if(state.editingMachine){
    const m=state.machines.find(x=>x.id===state.editingMachine);
    m.name=name;m.code=code;m.label=label||`${code} ${name.toUpperCase()}`;m.color=color;m.kpis=kpis;
    kpis.forEach(k=>{
      ['weekly','monthly','quarterly','yearly'].forEach(mode=>{
        const len=mode==='weekly'?52:mode==='quarterly'?4:mode==='yearly'?1:12;
        if(!m.data[mode])m.data[mode]={cyActual:{},cyTarget:{},pyActual:{}};
        if(!m.data[mode].cyActual[k.code])m.data[mode].cyActual[k.code]=new Array(len).fill(null);
        if(!m.data[mode].cyTarget[k.code])m.data[mode].cyTarget[k.code]=new Array(len).fill(null);
        if(!m.data[mode].pyActual[k.code])m.data[mode].pyActual[k.code]=new Array(len).fill(null);
      });
    });
    toast('Machine updated');
  } else {
    const id=name.toLowerCase().replace(/\s+/g,'_')+'_'+Date.now();
    const data={weekly:{cyActual:{},cyTarget:{},pyActual:{}},monthly:{cyActual:{},cyTarget:{},pyActual:{}},quarterly:{cyActual:{},cyTarget:{},pyActual:{}},yearly:{cyActual:{},cyTarget:{},pyActual:{}}};
    kpis.forEach(k=>{
      data.weekly.cyActual[k.code]=new Array(52).fill(null);
      data.weekly.cyTarget[k.code]=new Array(52).fill(k.target||null);
      data.weekly.pyActual[k.code]=new Array(52).fill(null);
      data.monthly.cyActual[k.code]=new Array(12).fill(null);
      data.monthly.cyTarget[k.code]=new Array(12).fill(k.target||null);
      data.monthly.pyActual[k.code]=new Array(12).fill(null);
      data.quarterly.cyActual[k.code]=new Array(4).fill(null);
      data.quarterly.cyTarget[k.code]=new Array(4).fill(k.target||null);
      data.quarterly.pyActual[k.code]=new Array(4).fill(null);
      data.yearly.cyActual[k.code]=[null];
      data.yearly.cyTarget[k.code]=[k.target||null];
      data.yearly.pyActual[k.code]=[null];
    });
    state.machines.push({id,name,code,label:label||`${code} ${name.toUpperCase()}`,color,kpis,data});
    toast('Machine added');
  }
  closeModal('addMachModal');renderSidebar();
  if(!state.activeMachine) selectMachine(state.machines[state.machines.length-1].id);
  else renderDashboard();
}

// â”€ DATA ENTRY â”€
let dataMachId=null;

function openDataModal(mid){
  dataMachId=mid;
  const m=state.machines.find(x=>x.id===mid);if(!m)return;
  document.getElementById('dataModalTitle').textContent=`Enter Data Â· ${m.name}`;
  const body=document.getElementById('dataModalBody');
  
  // View mode selector
  let modeHTML=`<div style="margin-bottom:16px;">
    <div style="font-family:'Barlow Condensed',sans-serif;font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.1em;margin-bottom:6px;">Data View Mode</div>
    <div class="vtabs">
      <button class="vtab" id="dataTabWeekly" onclick="switchDataTab('weekly')">Weekly</button>
      <button class="vtab active" id="dataTabMonthly" onclick="switchDataTab('monthly')">Monthly</button>
      <button class="vtab" id="dataTabQuarterly" onclick="switchDataTab('quarterly')">Quarterly</button>
      <button class="vtab" id="dataTabYearly" onclick="switchDataTab('yearly')">Yearly</button>
    </div>
  </div><div id="dataTabContent"></div>`;
  body.innerHTML=modeHTML;
  window._dataModalMode='monthly';
  renderDataTab(m,'monthly');
  document.getElementById('dataModal').classList.add('open');
}

function switchDataTab(mode){
  window._dataModalMode=mode;
  document.querySelectorAll('[id^="dataTab"]').forEach(t=>t.classList.remove('active'));
  document.getElementById('dataTab'+mode.charAt(0).toUpperCase()+mode.slice(1)).classList.add('active');
  const m=state.machines.find(x=>x.id===dataMachId);
  if(m)renderDataTab(m,mode);
}

function renderDataTab(m,mode){
  const el=document.getElementById('dataTabContent');
  const periods=mode==='weekly'?WEEKS:mode==='quarterly'?QUARTERS:mode==='yearly'?['2026']:MONTHS;
  el.innerHTML=m.kpis.map(kpi=>{
    const cyA=m.data[mode].cyActual[kpi.code]||new Array(periods.length).fill(null);
    const cyT=m.data[mode].cyTarget[kpi.code]||new Array(periods.length).fill(null);
    const pyA=m.data[mode].pyActual[kpi.code]||new Array(periods.length).fill(null);
    const mh=periods.map(p=>`<div class="mhc">${p}</div>`).join('');
    const row=(arr,type)=>arr.map((v,i)=>`<input class="mci" data-kpi="${kpi.code}" data-type="${type}" data-mode="${mode}" data-idx="${i}" value="${v??''}" type="number" step="any" placeholder="â€”">`).join('');
    const gridCols=mode==='weekly'?'repeat(13,1fr)':mode==='yearly'?'1fr':'repeat(12,1fr)';
    return`<div style="margin-bottom:16px;padding:13px 15px;background:var(--bg);border-radius:3px;border:1px solid var(--border);">
      <div style="font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:13px;text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px;">${kpi.code} Â· ${kpi.name}</div>
      ${mode!=='weekly'?`<div class="mhrow" style="grid-template-columns:${gridCols}">${mh}</div>`:''}
      ${mode==='weekly'?`
        <div style="margin-bottom:4px;font-size:10px;color:var(--muted);font-family:'Barlow Condensed',sans-serif;">Weeks 1-13</div>
        <div class="mhrow" style="grid-template-columns:repeat(13,1fr)">${periods.slice(0,13).map(p=>`<div class="mhc">${p}</div>`).join('')}</div>
        <div class="dsec">CY Actual</div><div class="mgrid" style="grid-template-columns:repeat(13,1fr);margin-bottom:7px">${row(cyA.slice(0,13),'cyActual')}</div>
        <div class="dsec">CY Target</div><div class="mgrid" style="grid-template-columns:repeat(13,1fr);margin-bottom:7px">${row(cyT.slice(0,13),'cyTarget')}</div>
        <div class="dsec">PY Actual</div><div class="mgrid" style="grid-template-columns:repeat(13,1fr);margin-bottom:12px">${row(pyA.slice(0,13),'pyActual')}</div>
        
        <div style="margin-bottom:4px;font-size:10px;color:var(--muted);font-family:'Barlow Condensed',sans-serif;">Weeks 14-26</div>
        <div class="mhrow" style="grid-template-columns:repeat(13,1fr)">${periods.slice(13,26).map(p=>`<div class="mhc">${p}</div>`).join('')}</div>
        <div class="dsec">CY Actual</div><div class="mgrid" style="grid-template-columns:repeat(13,1fr);margin-bottom:7px">${row(cyA.slice(13,26),'cyActual')}</div>
        <div class="dsec">CY Target</div><div class="mgrid" style="grid-template-columns:repeat(13,1fr);margin-bottom:7px">${row(cyT.slice(13,26),'cyTarget')}</div>
        <div class="dsec">PY Actual</div><div class="mgrid" style="grid-template-columns:repeat(13,1fr);margin-bottom:12px">${row(pyA.slice(13,26),'pyActual')}</div>
        
        <div style="margin-bottom:4px;font-size:10px;color:var(--muted);font-family:'Barlow Condensed',sans-serif;">Weeks 27-39</div>
        <div class="mhrow" style="grid-template-columns:repeat(13,1fr)">${periods.slice(26,39).map(p=>`<div class="mhc">${p}</div>`).join('')}</div>
        <div class="dsec">CY Actual</div><div class="mgrid" style="grid-template-columns:repeat(13,1fr);margin-bottom:7px">${row(cyA.slice(26,39),'cyActual')}</div>
        <div class="dsec">CY Target</div><div class="mgrid" style="grid-template-columns:repeat(13,1fr);margin-bottom:7px">${row(cyT.slice(26,39),'cyTarget')}</div>
        <div class="dsec">PY Actual</div><div class="mgrid" style="grid-template-columns:repeat(13,1fr);margin-bottom:12px">${row(pyA.slice(26,39),'pyActual')}</div>
        
        <div style="margin-bottom:4px;font-size:10px;color:var(--muted);font-family:'Barlow Condensed',sans-serif;">Weeks 40-52</div>
        <div class="mhrow" style="grid-template-columns:repeat(13,1fr)">${periods.slice(39,52).map(p=>`<div class="mhc">${p}</div>`).join('')}</div>
        <div class="dsec">CY Actual</div><div class="mgrid" style="grid-template-columns:repeat(13,1fr);margin-bottom:7px">${row(cyA.slice(39,52),'cyActual')}</div>
        <div class="dsec">CY Target</div><div class="mgrid" style="grid-template-columns:repeat(13,1fr);margin-bottom:7px">${row(cyT.slice(39,52),'cyTarget')}</div>
        <div class="dsec">PY Actual</div><div class="mgrid" style="grid-template-columns:repeat(13,1fr)">${row(pyA.slice(39,52),'pyActual')}</div>
      `:`
        <div class="dsec">CY Actual</div><div class="mgrid" style="grid-template-columns:${gridCols};margin-bottom:7px">${row(cyA,'cyActual')}</div>
        <div class="dsec">CY Target</div><div class="mgrid" style="grid-template-columns:${gridCols};margin-bottom:7px">${row(cyT,'cyTarget')}</div>
        <div class="dsec">PY Actual</div><div class="mgrid" style="grid-template-columns:${gridCols}">${row(pyA,'pyActual')}</div>
      `}
    </div>`;
  }).join('');
}

function saveMonthlyData(){
  const m=state.machines.find(x=>x.id===dataMachId);if(!m)return;
  document.querySelectorAll('[data-kpi][data-mode]').forEach(inp=>{
    const {kpi,type,mode,idx}=inp.dataset;
    if(!m.data[mode])m.data[mode]={cyActual:{},cyTarget:{},pyActual:{}};
    if(!m.data[mode][type])m.data[mode][type]={};
    const periods=mode==='weekly'?52:mode==='quarterly'?4:mode==='yearly'?1:12;
    if(!m.data[mode][type][kpi])m.data[mode][type][kpi]=new Array(periods).fill(null);
    const v=inp.value.trim();
    m.data[mode][type][kpi][parseInt(idx)]=v===''?null:parseFloat(v);
  });
  closeModal('dataModal');renderDashboard();toast('Data saved');
}

// â”€ IMPORT / EXPORT â”€
function openImportModal(){document.getElementById('importModal').classList.add('open');}

const dz=document.getElementById('dropZone');
dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('drag');});
dz.addEventListener('dragleave',()=>dz.classList.remove('drag'));
dz.addEventListener('drop',e=>{dz.classList.remove('drag');e.preventDefault();const f=e.dataTransfer.files[0];if(f)processFile(f);});
function handleFileSelect(e){const f=e.target.files[0];if(f)processFile(f);}

function processFile(file){
  const st=document.getElementById('importStatus');st.textContent='Readingâ€¦';
  const reader=new FileReader();
  reader.onload=e=>{
    try{const wb=XLSX.read(e.target.result,{type:'array'});parseXLSX(wb);closeModal('importModal');toast('Imported successfully');renderSidebar();renderDashboard();}
    catch(err){st.textContent='Error: '+err.message;st.style.color='var(--red)';}
  };
  reader.readAsArrayBuffer(file);
}

function parseXLSX(wb){
  const gs=n=>{const s=wb.Sheets[n];return s?XLSX.utils.sheet_to_json(s,{header:1,defval:null}):null;};
  
  // Check if this is a production efficiency report
  const firstSheet = wb.SheetNames[0];
  const firstData = gs(firstSheet);
  const isProductionReport = firstData && firstData[0] && String(firstData[0][0]||'').includes('Production Efficiency');
  
  if(isProductionReport){
    parseProductionEfficiencyReport(wb, firstData);
    return;
  }
  
  // Original KPI format parsing
  const monthly={cyA:gs('CY Actual Monthly'),cyT:gs('CY Target Monthly'),pyA:gs('PY Actual Monthly')};
  const quarterly={cyA:gs('CY Actual Quarterly'),cyT:gs('CY Target Quarterly'),pyA:gs('PY Actual Quarterly')};
  const yearly={cyA:gs('CY Actual Yearly'),cyT:gs('CY Target Yearly'),pyA:gs('PY Actual Yearly')};
  const kpiI=gs('KPIs Info');
  
  if(!monthly.cyA)monthly.cyA=gs('CY Actual');
  if(!monthly.cyT)monthly.cyT=gs('CY Target');
  if(!monthly.pyA)monthly.pyA=gs('PY Actual');
  
  if(!monthly.cyA||!monthly.cyT){toast('Missing required sheets','error');return;}
  
  const meta={};
  if(kpiI) kpiI.slice(4).forEach(row=>{const c=String(row[1]||'').trim();if(c&&!isNaN(c))meta[c]={code:c,name:(row[2]||'').trim(),criteria:(row[3]||'').trim(),unit:(row[4]||'').trim(),lowerBetter:(row[6]||'').toLowerCase()==='yes'};});
  
  const mmap={};
  const parseRow=(row,startCol,count)=>{const arr=[];for(let i=0;i<count;i++)arr.push(row[startCol+i]==null?null:parseFloat(row[startCol+i])||null);return arr;};
  
  monthly.cyA.slice(4).forEach((row,ri)=>{
    const c=String(row[1]||'').trim();if(!c||isNaN(c))return;
    const p=c[0];if(!mmap[p])mmap[p]={};if(!mmap[p][c])mmap[p][c]={monthly:{},quarterly:{},yearly:{},weekly:{}};
    mmap[p][c].monthly.cyActual=parseRow(row,4,12);
    const tRow=monthly.cyT.slice(4)[ri];mmap[p][c].monthly.cyTarget=tRow?parseRow(tRow,4,12):new Array(12).fill(null);
    if(monthly.pyA){const pRow=monthly.pyA.slice(4)[ri];mmap[p][c].monthly.pyActual=pRow?parseRow(pRow,4,12):new Array(12).fill(null);}
    else mmap[p][c].monthly.pyActual=new Array(12).fill(null);
  });
  
  if(quarterly.cyA){
    quarterly.cyA.slice(4).forEach((row,ri)=>{
      const c=String(row[1]||'').trim();if(!c||isNaN(c))return;
      const p=c[0];if(!mmap[p]||!mmap[p][c])return;
      mmap[p][c].quarterly.cyActual=parseRow(row,4,4);
      const tRow=quarterly.cyT?quarterly.cyT.slice(4)[ri]:null;mmap[p][c].quarterly.cyTarget=tRow?parseRow(tRow,4,4):new Array(4).fill(null);
      const pRow=quarterly.pyA?quarterly.pyA.slice(4)[ri]:null;mmap[p][c].quarterly.pyActual=pRow?parseRow(pRow,4,4):new Array(4).fill(null);
    });
  }
  
  if(yearly.cyA){
    yearly.cyA.slice(4).forEach((row,ri)=>{
      const c=String(row[1]||'').trim();if(!c||isNaN(c))return;
      const p=c[0];if(!mmap[p]||!mmap[p][c])return;
      mmap[p][c].yearly.cyActual=[row[4]==null?null:parseFloat(row[4])||null];
      const tRow=yearly.cyT?yearly.cyT.slice(4)[ri]:null;mmap[p][c].yearly.cyTarget=tRow?[tRow[4]==null?null:parseFloat(tRow[4])||null]:[null];
      const pRow=yearly.pyA?yearly.pyA.slice(4)[ri]:null;mmap[p][c].yearly.pyActual=pRow?[pRow[4]==null?null:parseFloat(pRow[4])||null]:[null];
    });
  }
  
  Object.keys(mmap).forEach(prefix=>{
    Object.keys(mmap[prefix]).forEach(code=>{
      if(!mmap[prefix][code].quarterly.cyActual)mmap[prefix][code].quarterly={cyActual:new Array(4).fill(null),cyTarget:new Array(4).fill(null),pyActual:new Array(4).fill(null)};
      if(!mmap[prefix][code].yearly.cyActual)mmap[prefix][code].yearly={cyActual:[null],cyTarget:[null],pyActual:[null]};
      if(!mmap[prefix][code].weekly)mmap[prefix][code].weekly={cyActual:new Array(52).fill(null),cyTarget:new Array(52).fill(null),pyActual:new Array(52).fill(null)};
    });
  });
  
  Object.keys(mmap).forEach(prefix=>{
    const codes=Object.keys(mmap[prefix]);
    const existing=state.machines.find(m=>m.code&&m.code[0]===prefix);
    const kpis=codes.map(c=>({code:c,name:meta[c]?.name||c,criteria:meta[c]?.criteria||'',unit:meta[c]?.unit||'Avg',lowerBetter:meta[c]?.lowerBetter||false}));
    const data={weekly:{cyActual:{},cyTarget:{},pyActual:{}},monthly:{cyActual:{},cyTarget:{},pyActual:{}},quarterly:{cyActual:{},cyTarget:{},pyActual:{}},yearly:{cyActual:{},cyTarget:{},pyActual:{}}};
    codes.forEach(c=>{
      ['weekly','monthly','quarterly','yearly'].forEach(mode=>{
        data[mode].cyActual[c]=mmap[prefix][c][mode].cyActual||new Array(mode==='weekly'?52:mode==='quarterly'?4:mode==='yearly'?1:12).fill(null);
        data[mode].cyTarget[c]=mmap[prefix][c][mode].cyTarget||new Array(mode==='weekly'?52:mode==='quarterly'?4:mode==='yearly'?1:12).fill(null);
        data[mode].pyActual[c]=mmap[prefix][c][mode].pyActual||new Array(mode==='weekly'?52:mode==='quarterly'?4:mode==='yearly'?1:12).fill(null);
      });
    });
    if(existing){existing.kpis=kpis;existing.data=data;}
    else state.machines.push({id:'m_'+prefix+'_'+Date.now(),name:'Machine '+prefix+'xx',code:prefix+'00',label:prefix+'00 Machine',color:COLORS[state.machines.length%COLORS.length],kpis,data});
  });
}

function parseProductionEfficiencyReport(wb, data){
  // Find machine name from row 10 (format: "415 J&L SFG 115")
  let machineName = '';
  let machineCode = '';
  for(let i=0;i<data.length;i++){
    const cell = String(data[i][0]||'').trim();
    if(cell && /^\d{3}\s/.test(cell)){
      machineName = cell;
      machineCode = cell.split(' ')[0];
      break;
    }
  }
  
  if(!machineName){toast('Could not find machine name in report','error');return;}
  
  // Find data row (row with shift number, usually row 11)
  let dataRow = null;
  for(let i=10;i<data.length;i++){
    const cell = String(data[i][0]||'').trim();
    if(cell && !isNaN(cell) && parseInt(cell)>=1 && parseInt(cell)<=3){
      dataRow = data[i];
      break;
    }
  }
  
  if(!dataRow){toast('Could not find data in report','error');return;}
  
  // Parse metrics (based on column positions from analysis)
  // Col 3: Production Qty, Col 5: Setups, Col 7: Waste Qty
  // Col 8: Setup Hrs, Col 9: Run Hrs, Col 16: Down Time
  // Col 17: Utilization, Col 18: Setup Eff, Col 19: Run Eff, Col 20: Total Eff
  
  const metrics = {
    setupTime: parseFloat(dataRow[8])||null,        // Setup Hrs
    downtime: (parseFloat(dataRow[16])||0)*100,     // Down Time (convert to %)
    feedsRunHr: parseFloat(dataRow[6])||null,       // Rate Qty/Hr
    utilization: (parseFloat(dataRow[17])||0)*100,  // Utilization (convert to %)
    efficiency: (parseFloat(dataRow[20])||0)*100,   // Total Efficiency (convert to %)
    waste: parseFloat(dataRow[7])||null,            // Waste Qty
    productionQty: parseFloat(dataRow[3])||null,    // Production Qty
    runHours: parseFloat(dataRow[9])||null          // Run Hours
  };
  
  // Get or extract week number from date range in report
  const dateRange = String(data[1][10]||'');
  const weekMatch = dateRange.match(/(\d+)\/(\d+)\/(\d+)/);
  let weekNum = 6; // Default to week 6 (mid-Feb)
  if(weekMatch){
    const month = parseInt(weekMatch[1]);
    const day = parseInt(weekMatch[2]);
    weekNum = Math.ceil((month*30 + day)/7);
    if(weekNum>52) weekNum=52;
  }
  
  // Create or update machine
  const existing = state.machines.find(m=>m.name===machineName || m.code===machineCode);
  
  const kpis = [
    {code:'101',name:'Setup Time',criteria:'Avg setup time per job/changeover',unit:'Hrs',lowerBetter:true},
    {code:'102',name:'Downtime',criteria:'% of time machine is down',unit:'%',lowerBetter:true},
    {code:'103',name:'Feeds/RunHr',criteria:'Avg feeds per actual run hour',unit:'Qty/Hr',lowerBetter:false},
    {code:'104',name:'Utilization',criteria:'Machine utilization percentage',unit:'%',lowerBetter:false},
    {code:'105',name:'Efficiency',criteria:'Overall equipment efficiency',unit:'%',lowerBetter:false},
    {code:'106',name:'Waste Qty',criteria:'Total waste quantity',unit:'Qty',lowerBetter:true},
  ];
  
  if(existing){
    // Update existing machine with new data
    const mode='weekly';
    if(!existing.data[mode])existing.data[mode]={cyActual:{},cyTarget:{},pyActual:{}};
    existing.data[mode].cyActual['101'][weekNum-1]=metrics.setupTime;
    existing.data[mode].cyActual['102'][weekNum-1]=metrics.downtime;
    existing.data[mode].cyActual['103'][weekNum-1]=metrics.feedsRunHr;
    existing.data[mode].cyActual['104'][weekNum-1]=metrics.utilization;
    existing.data[mode].cyActual['105'][weekNum-1]=metrics.efficiency;
    existing.data[mode].cyActual['106'][weekNum-1]=metrics.waste;
    toast(`Updated ${machineName} - Week ${weekNum} data`);
  } else {
    // Create new machine
    const data={weekly:{cyActual:{},cyTarget:{},pyActual:{}},monthly:{cyActual:{},cyTarget:{},pyActual:{}},quarterly:{cyActual:{},cyTarget:{},pyActual:{}},yearly:{cyActual:{},cyTarget:{},pyActual:{}}};
    kpis.forEach(k=>{
      ['weekly','monthly','quarterly','yearly'].forEach(mode=>{
        const len=mode==='weekly'?52:mode==='quarterly'?4:mode==='yearly'?1:12;
        data[mode].cyActual[k.code]=new Array(len).fill(null);
        data[mode].cyTarget[k.code]=new Array(len).fill(null);
        data[mode].pyActual[k.code]=new Array(len).fill(null);
      });
    });
    
    // Set the weekly data
    data.weekly.cyActual['101'][weekNum-1]=metrics.setupTime;
    data.weekly.cyActual['102'][weekNum-1]=metrics.downtime;
    data.weekly.cyActual['103'][weekNum-1]=metrics.feedsRunHr;
    data.weekly.cyActual['104'][weekNum-1]=metrics.utilization;
    data.weekly.cyActual['105'][weekNum-1]=metrics.efficiency;
    data.weekly.cyActual['106'][weekNum-1]=metrics.waste;
    
    const id='prod_'+machineCode+'_'+Date.now();
    state.machines.push({id,name:machineName,code:machineCode,label:machineName,color:COLORS[state.machines.length%COLORS.length],kpis,data});
    toast(`Imported ${machineName} - Week ${weekNum} data`);
  }
}

function exportData(){
  const m=state.machines.find(x=>x.id===state.activeMachine);
  if(!m){toast('Select a machine first','error');return;}
  const mode=window._viewMode;
  const wb=XLSX.utils.book_new();
  const periods=mode==='weekly'?WEEKS:mode==='quarterly'?QUARTERS:mode==='yearly'?['2026']:MONTHS;
  const hdr=['KPI Code','KPI Name','Criteria','Unit',...periods];
  ['cyActual','cyTarget','pyActual'].forEach((type,ti)=>{
    const label=['CY Actual','CY Target','PY Actual'][ti];
    const rows=[hdr,...m.kpis.map(kpi=>[kpi.code,kpi.name,kpi.criteria,kpi.unit,...(m.data[mode][type][kpi.code]||new Array(periods.length).fill(null))])];
    XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(rows),`${label} ${mode.charAt(0).toUpperCase()+mode.slice(1)}`);
  });
  XLSX.writeFile(wb,`KPI_${m.name}_${mode}_${new Date().toISOString().slice(0,10)}.xlsx`);
  toast('Exported');
}

function closeModal(id){document.getElementById(id).classList.remove('open');}
document.querySelectorAll('.modal-bg').forEach(bg=>bg.addEventListener('click',e=>{if(e.target===bg)bg.classList.remove('open');}));

seedData();renderSidebar();selectMachine(state.machines[0].id);
</script>
</body>
</html>
